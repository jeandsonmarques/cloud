from pathlib import Path
text = Path("data_summarizer.py").read_text(encoding="utf-8")
insert_pos = text.index("    def show_dashboard")
new_block = "    def _materialize_power_query_result(self, df: pd.DataFrame, geometry_available: bool):\n        if df is None or df.empty:\n            QMessageBox.information(self, \"Criar camada\", \"Nenhum dado disponivel para materializar.\")\n            return\n\n        source_layer, target_layer, geometry_layer = self._get_compare_context_layers()\n        geometry_layer = geometry_layer or target_layer or source_layer\n\n        can_recover_geometry = bool(geometry_available)\n        if not can_recover_geometry and geometry_layer is not None and geometry_layer.isValid():\n            can_recover_geometry = \"__target_feature_id\" in df.columns\n\n        base_name = \"\"\n        if target_layer is not None:\n            base_name = target_layer.name()\n        elif source_layer is not None:\n            base_name = source_layer.name()\n        if not base_name:\n            base_name = \"PowerQuery\"\n\n        self._materialize_dataframe_dialog(\n            df,\n            base_name,\n            can_use_geometry=can_recover_geometry,\n            geometry_layer=geometry_layer,\n            settings_key=\"PowerBISummarizer/powerquery/lastMaterializeDir\",\n            dialog_title=\"Criar camada\",\n            table_prefix=\"Tabela\",\n            memory_prefix=\"PowerQuery\",\n            export_prefix=\"PowerQuery\",\n        )\n\n    def _materialize_dataframe_dialog(\n        self,\n        df: pd.DataFrame,\n        base_name: str,\n        can_use_geometry: bool,\n        geometry_layer: Optional[QgsVectorLayer],\n        settings_key: str,\n        dialog_title: str,\n        table_prefix: str,\n        memory_prefix: str,\n        export_prefix: str,\n    ):\n        if df is None or df.empty:\n            QMessageBox.information(self, dialog_title, \"Nenhum dado disponivel para materializar.\")\n            return\n\n        base_name = (base_name or \"resultado\").strip()\n        if not base_name:\n            base_name = \"resultado\"\n\n        options = [\"Tabela (somente atributos)\"]\n        gpkg_label = \"Salvar como GPKG\"\n        if can_use_geometry:\n            options.append(\"Camada temporaria (memoria)\")\n            options.append(gpkg_label)\n        else:\n            gpkg_label = \"Salvar como GPKG (tabela)\"\n            options.append(gpkg_label)\n\n        choice, ok = slim_get_item(\n            self,\n            dialog_title,\n            \"Escolha como deseja materializar o resultado atual:\",\n            options,\n            0,\n            False,\n        )\n        if not ok or not choice:\n            return\n\n        if choice.startswith(\"Tabela\"):\n            table_name = self._unique_layer_name(f"{table_prefix} {base_name}".strip())\n            layer, error_message = self._create_layer_from_dataframe(\n                df,\n                table_name,\n                with_geometry=False,\n            )\n            if layer is None:\n                QMessageBox.warning(\n                    self,\n                    dialog_title,\n                    error_message or \"Nao foi possivel gerar a tabela.\",\n                )\n                return\n            QgsProject.instance().addMapLayer(layer)\n            QMessageBox.information(\n                self,\n                dialog_title,\n                f"Tabela '{layer.name()}' criada com {layer.featureCount()} registros.",\n            )\n            return\n\n        if choice.startswith(\"Camada temporaria\"):\n            layer_name = self._unique_layer_name(f"{memory_prefix} {base_name}".strip())\n            layer, error_message = self._create_layer_from_dataframe(\n                df,\n                layer_name,\n                with_geometry=True,\n                geometry_layer=geometry_layer,\n            )\n            if layer is None:\n                QMessageBox.warning(\n                    self,\n                    dialog_title,\n                    error_message or \"Nao foi possivel criar a camada temporaria.\",\n                )\n                return\n            QgsProject.instance().addMapLayer(layer)\n            QMessageBox.information(\n                self,\n                dialog_title,\n                f"Camada '{layer.name()}' criada com {layer.featureCount()} feicoes.",\n            )\n            return\n\n        if choice.startswith(\"Salvar como GPKG\"):\n            suggested_name = re.sub(r"[^a-zA-Z0-9_\\\\-]+", "_", base_name).strip("_") or "resultado"